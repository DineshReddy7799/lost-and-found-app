{% extends "baseapp/base.html" %}

{% block content %}
<h1 class="mb-4">Items Map Overview üó∫Ô∏è</h1>

<div class="card card-body shadow-sm">
    {% comment %} The "Search Along a Route" buttons are commented out below {% endcomment %}
    <div id="fullMap" style="height: 70vh; border-radius: 0.5rem;"></div>
</div>

{% comment %} The container for the search results list is commented out below {% endcomment %}
<div class="modal fade" id="itemDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title" id="modal-item-title"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6"><img id="modal-item-photo" src="" class="img-fluid rounded mb-3"></div>
                    <div class="col-md-6">
                        <h5 id="modal-item-title-body"></h5><p><span id="modal-item-status-badge" class="badge"></span></p><h5>Description</h5><p id="modal-item-description"></p>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item"><strong>Category:</strong> <span id="modal-item-type"></span></li>
                            <li class="list-group-item"><strong>Location:</strong> <span id="modal-item-location"></span> <a id="modal-location-link" href="#" target="_blank" class="ms-2 small">(View on Map)</a></li>
                            <li class="list-group-item"><strong>Date:</strong> <span id="modal-item-date"></span></li>
                            <li class="list-group-item"><strong>Reported by:</strong> <span id="modal-item-user"></span> <span id="modal-user-verified-badge" class="badge bg-primary ms-1" style="display: none;">‚úîÔ∏è Verified</span></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-between"><div id="modal-action-buttons"></div><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
    {{ block.super }}
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const map = L.map('fullMap').setView([14.1285, 77.3653], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        setTimeout(() => { map.invalidateSize(); }, 100);

        const itemsData = {{ items_data|safe }};
        const markers = L.markerClusterGroup();

        // Add initial markers for all items
        itemsData.forEach(item => {
            // Note: your map_overview_view must send 'lat' and 'lon' keys for this to work
            const marker = L.marker([item.lat, item.lon]);
            marker.bindPopup(`<b>${item.title}</b>`);
            markers.addLayer(marker);
        });
        map.addLayer(markers);


        /* --- The following section for the "Search Along a Route" feature has been commented out ---

        let drawnItems = new L.FeatureGroup().addTo(map);
        let drawnRouteCoords = null;

        const drawControl = new L.Control.Draw({
            edit: { featureGroup: drawnItems },
            draw: {
                polygon: false, rectangle: false, circle: false, marker: false, circlemarker: false,
                polyline: { shapeOptions: { color: '#0d6efd' } }
            }
        });
        map.addControl(drawControl);

        map.on(L.Draw.Event.CREATED, function (event) {
            drawnItems.clearLayers();
            const layer = event.layer;
            drawnItems.addLayer(layer);
            drawnRouteCoords = layer.getLatLngs().map(latlng => [latlng.lng, latlng.lat]);
            document.getElementById('search-container').style.display = 'block';
        });

        document.getElementById('search-route-btn').addEventListener('click', function() {
            if (!drawnRouteCoords) return;
            const searchUrl = "{% url 'search_route' %}";
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch(searchUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                body: JSON.stringify({ route: drawnRouteCoords })
            })
            .then(response => response.json())
            .then(data => {
                markers.clearLayers();
                const resultsContainer = document.getElementById('results-container');
                resultsContainer.innerHTML = '';
                if (data.items && data.items.length > 0) {
                    let resultsHtml = `<h3 class="mb-3">Found ${data.items.length} item(s)</h3><div class="list-group">`;
                    data.items.forEach(item => {
                        resultsHtml += `<div class="list-group-item list-group-item-action item-card" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#itemDetailModal" data-item-id="${item.id}" data-title="${item.title}" data-status="${item.status}" data-item-type="${item.item_type}" data-description="${item.description}" data-location="${item.location_name}" data-latitude="${item.latitude}" data-longitude="${item.longitude}" data-date="${item.date}" data-user="${item.user}" data-owner-id="${item.owner_id}" data-owner-verified="${item.owner_verified}" data-photo-url="${item.photo_url}" data-edit-url="${item.edit_url}" data-delete-url="${item.delete_url}" data-start-chat-url="${item.start_chat_url}" data-secret-question="${item.secret_question}">${item.title}</div>`;
                        const marker = L.marker([item.latitude, item.longitude]);
                        marker.bindTooltip(item.title, { permanent: true, direction: 'top', className: 'item-map-label' }).openTooltip();
                        markers.addLayer(marker);
                    });
                    resultsHtml += '</div>';
                    resultsContainer.innerHTML = resultsHtml;
                } else {
                    resultsContainer.innerHTML = '<div class="alert alert-info">No items were found along this route.</div>';
                }
            });
        });

        document.getElementById('reset-map-btn').addEventListener('click', () => location.reload());

        const itemDetailModal = document.getElementById('itemDetailModal');
        const currentUserId = {{ user.id|default:'null' }};

        if (itemDetailModal) {
            itemDetailModal.addEventListener('show.bs.modal', function (event) {
                const clickedItem = event.relatedTarget;
                const data = clickedItem.dataset;
                // ... full script to populate modal ...
            });
        }
        */
    });
    </script>
{% endblock %}